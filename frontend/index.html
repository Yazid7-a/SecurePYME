<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>SecurePYME - Esc√°ner de Puertos</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

  <h1>SecurePYME - Escaneo de Seguridad</h1>

  <div class="container">

    <!-- Formulario de login -->
    <div id="login-container" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">
      <h2>Login de Usuario</h2>
      <input type="text" id="login-username" placeholder="Nombre de usuario">
      <input type="password" id="login-password" placeholder="Contrase√±a">
      <button onclick="login()">Iniciar Sesi√≥n</button>
      <button onclick="cerrarSesion()" style="display:none;" id="cerrar-sesion-btn">Cerrar Sesi√≥n</button>
      <div id="mensaje-login"></div>
    </div>

    <!-- Formulario de escaneo -->
    <div style="display: flex; gap: 10px; flex-direction: column;">
      <label for="host">Introduce una direcci√≥n web:</label>
      <input type="text" id="host" placeholder="ej: scanme.nmap.org" />
      <button onclick="escanear()">Escanear</button>
      <button id="btn-historial" onclick="toggleHistorial()">Mostrar Historial</button>
    </div>

    <h2>Resultados del Escaneo:</h2>
    <pre id="resultados"></pre>

    <!-- Historial -->
    <div id="historial-contenedor" style="display: none;">
      <h2>Historial de Escaneos:</h2>
    
      <input type="text" id="busqueda" placeholder="Buscar por host o fecha..." onkeyup="filtrarHistorial()" style="margin-bottom: 10px; padding: 8px; width: 100%;">
    
      <table id="historial-table" border="1" style="width: 100%; text-align: center;">
        <thead>
          <tr>
            <th>#</th>
            <th>Host</th>
            <th>Fecha</th>
            <th>Puertos</th>
          </tr>
        </thead>
        <tbody id="historial-body">
          <!-- Aqu√≠ se cargar√°n los escaneos -->
        </tbody>
      </table>
    </div>    

  </div>

  <script>
    // --- Funci√≥n de login
    async function login() {
      const username = document.getElementById("login-username").value.trim();
      const password = document.getElementById("login-password").value.trim();
      const mensajeLogin = document.getElementById("mensaje-login");

      if (username === "" || password === "") {
        alert("Por favor, completa todos los campos.");
        return;
      }

      try {
        const res = await fetch('http://127.0.0.1:8000/login/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ username, password })
        });

        if (res.ok) {
          localStorage.setItem("usuario", username);
          mensajeLogin.innerText = `‚úÖ Bienvenido, ${username}`;
          document.getElementById("cerrar-sesion-btn").style.display = "block";
          document.getElementById("login-username").style.display = "none";
          document.getElementById("login-password").style.display = "none";
        } else {
          const data = await res.json();
          mensajeLogin.innerText = `‚ùå Error: ${data.detail}`;
        }

      } catch (err) {
        mensajeLogin.innerText = "Error al conectar con el servidor.";
      }
    }

    function cerrarSesion() {
      localStorage.removeItem("usuario");
      location.reload(); // Recargamos la p√°gina para limpiar todo
    }

    function comprobarSesion() {
      const usuario = localStorage.getItem("usuario");
      const mensajeLogin = document.getElementById("mensaje-login");

      if (usuario) {
        mensajeLogin.innerText = `‚úÖ Bienvenido, ${usuario}`;
        document.getElementById("cerrar-sesion-btn").style.display = "block";
        document.getElementById("login-username").style.display = "none";
        document.getElementById("login-password").style.display = "none";
      }
    }

    // --- Funci√≥n para escanear
        async function escanear() {
      const usuario = localStorage.getItem("usuario");
      if (!usuario) {
        alert("Debes iniciar sesi√≥n para escanear.");
        return;
      }

      const host = document.getElementById("host").value.trim();
      const resultados = document.getElementById("resultados");

      if (host === "") {
        alert("Por favor, introduce una direcci√≥n web o IP antes de escanear.");
        return;
      }

      if (!host.includes(".")) {
        alert("Por favor, introduce una direcci√≥n web v√°lida (ejemplo: example.com o scanme.nmap.org).");
        return;
      }

      resultados.textContent = "Escaneando...";

      try {
        const res = await fetch(`http://127.0.0.1:8000/scan/?host=${host}`);
        const data = await res.json();

        if (data.error) {
          resultados.textContent = "Error: " + data.error;
        } else {
          let salida = `Host: ${data.host}\n\nPuertos encontrados:\n\n`;

          if (!data.ports || data.ports.length === 0) {
            salida += "‚ö†Ô∏è No se encontraron puertos abiertos o el host no respondi√≥.";
          } else {
            data.ports.forEach(p => {
              const estado = p.state === "open" ? "üü¢ ABIERTO" : "üü† FILTRADO";
              salida += `‚Üí ${p.port} (${p.service}) - ${estado}\n`;
            });
          }

          resultados.textContent = salida;
        }
      } catch (err) {
        resultados.textContent = "Error al conectar con el servidor: " + err;
      }
    }


    // --- Funci√≥n de historial
    let historialVisible = false;

    async function toggleHistorial() {
      const historialContenedor = document.getElementById("historial-contenedor");
      const boton = document.getElementById("btn-historial");

      if (!historialVisible) {
        await verHistorial();
        historialContenedor.style.display = "block";
        boton.textContent = "Ocultar Historial";
        historialVisible = true;
      } else {
        historialContenedor.style.display = "none";
        boton.textContent = "Mostrar Historial";
        historialVisible = false;
      }
    }

    async function verHistorial() {
      const historialBody = document.getElementById("historial-body");
      historialBody.innerHTML = ""; // Limpiamos la tabla primero

      try {
        const res = await fetch(`http://127.0.0.1:8000/historial/?limite=10`);
        const data = await res.json();

        if (data.length === 0) {
          const row = `<tr><td colspan="4">No hay escaneos guardados todav√≠a.</td></tr>`;
          historialBody.innerHTML = row;
          return;
        }

        data.forEach((item, index) => {
          let puertos = "";
          item.puertos.forEach(p => {
            puertos += `${p.puerto} (${p.servicio}) - ${p.estado}<br>`;
          });

          const row = `
            <tr>
              <td>${index + 1}</td>
              <td>${item.host}</td>
              <td>${item.fecha_hora}</td>
              <td>${puertos}</td>
            </tr>
          `;
          historialBody.innerHTML += row;
        });

      } catch (err) {
        historialBody.innerHTML = `<tr><td colspan="4">Error al cargar historial: ${err}</td></tr>`;
      }
    }

    function filtrarHistorial() {
      const input = document.getElementById("busqueda").value.toLowerCase();
      const filas = document.querySelectorAll("#historial-body tr");

      filas.forEach(fila => {
        const host = fila.children[1]?.textContent.toLowerCase();
        const fecha = fila.children[2]?.textContent.toLowerCase();

        if (host.includes(input) || fecha.includes(input)) {
          fila.style.display = "";
        } else {
          fila.style.display = "none";
        }
      });
    }

    // --- Comprobar sesi√≥n al cargar la p√°gina
    comprobarSesion();
  </script>

</body>
</html>
